<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Portugal Electrical Grid interruptions</title>
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" type="text/css">
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }

    #myMap {
      height: 100%;
      width: 100%;
    }

    #map-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 10px;
      z-index: 1000;
      max-width: 80%;
      border-radius: 8px;
      font-size: 14px;
    }

    #map-overlay h2 {
      margin: 0 0 5px 0;
      font-size: 16px;
    }

    #map-overlay p {
      margin: 0;
      font-size: 12px;
    }

    @media (max-width: 480px) {
      #map-overlay {
        padding: 8px;
        max-width: 85%;
      }
      
      #map-overlay h2 {
        font-size: 14px;
      }
      
      #map-overlay p {
        font-size: 11px;
      }
    }
  </style>
</head>

<body>
  <div id="map-overlay">
    <h2>ðŸ‡µðŸ‡¹ Electrical Grid Outages</h2>
    <p>Data provided by <a
        href="https://e-redes.opendatasoft.com/explore/dataset/outages-per-geography/information/">E-REDES</a></p>
  </div>
  <div id="myMap"></div>
  <script>
    const CONFIG = {
        apiEndpoint: 'https://e-redes.opendatasoft.com/api/explore/v2.1/catalog/datasets/outages-per-geography/records',
        subscriptionKey: '4GFIA7hQBBvNZi9ACsKWHSzkdxzyxmDpnlcBtlqn7PA34NsKhNcQJQQJ99ALAC5RqLJM3OneAAAgAZMP1dUS',
        mapSettings: {
            center: [-8.2245, 39.3999],
            zoom: 6.2,
            style: 'grayscale_dark',
            bounds: [-9.5, 36.8, -6.1, 42.2] // Continental Portugal bounds
        }
    };

    // Initialize map with configuration
    function initializeMap() {
        return new atlas.Map('myMap', {
            ...CONFIG.mapSettings,
            authOptions: {
                authType: 'subscriptionKey',
                subscriptionKey: CONFIG.subscriptionKey
            }
        });
    }

    // Handle case when no outages are reported
    function displayNoOutagesMessage() {
        const mapOverlay = document.getElementById('map-overlay');
        const message = document.createElement('p');
        message.innerHTML = 'Currently no outages reported.';
        mapOverlay.appendChild(message);
    }

    // Create layers for map visualization
    function createMapLayers(map, dataSource) {
        // Symbol layer for individual markers
        const symbolLayer = new atlas.layer.SymbolLayer(dataSource, null, {
            iconOptions: { image: 'marker-red' }
        });

        // Cluster layer for grouped markers
        const clusterLayer = new atlas.layer.BubbleLayer(dataSource, null, {
            radius: 12,
            color: '#007faa',
            strokeColor: 'white',
            strokeWidth: 2,
            filter: ['has', 'point_count']
        });

        // Labels for clusters
        const clusterLabelLayer = new atlas.layer.SymbolLayer(dataSource, null, {
            iconOptions: { image: 'none' },
            textOptions: {
                textField: ['get', 'point_count_abbreviated'],
                offset: [0, 0.4],
                color: 'white'
            },
            filter: ['has', 'point_count']
        });

        map.layers.add(symbolLayer);
        map.layers.add(clusterLayer);
        map.layers.add(clusterLabelLayer);

        return { symbolLayer, clusterLayer };
    }

    // Add click event handlers for popups
    function setupClickHandlers(map, dataSource, layers) {
        map.events.add('click', layers.symbolLayer, (e) => {
            if (e.shapes && e.shapes.length > 0) {
                new atlas.Popup({
                    content: e.shapes[0].getProperties().title,
                    position: e.position
                }).open(map);
            }
        });

        map.events.add('click', layers.clusterLayer, (e) => {
            const clusteredPoints = dataSource.getClusterLeaves(e.shapes[0], Infinity);
            const content = clusteredPoints
                .map(point => point.getProperties().title)
                .join('<br>');
            
            new atlas.Popup({
                content: `<div style="padding:10px"><b>Outages</b><br>${content}</div>`,
                position: e.position
            }).open(map);
        });
    }

    // Fetch data from E-REDES API
    async function fetchOutageData() {
        try {
            const params = new URLSearchParams({
                'limit': 20
            });

            const url = `${CONFIG.apiEndpoint}?${params.toString()}`;
            console.log('Fetching from:', url);

            const response = await fetch(url);
            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('API Response:', data);

            // Check if the only result is the "no outages" indicator
            if (data.results.length === 1 && 
                data.results[0].zipcode === null && 
                data.results[0].municipality === null && 
                data.results[0].interrupcao_ativa === 1) {
                return [];  // Return empty array to trigger "no outages" message
            }

            // Filter out any null records just in case
            return data.results.filter(record => 
                record.zipcode !== null && 
                record.municipality !== null
            );
        } catch (error) {
            console.error('Error fetching outage data:', error);
            return [];
        }
    }

    // Process location data and add to map
    async function processLocation(dataSource, record) {
        // The API response doesn't have a fields property, the data is directly in the record
        if (!record?.municipality || !record?.zipcode) return;

        const searchUrl = `https://atlas.microsoft.com/search/address/json?subscription-key=${CONFIG.subscriptionKey}&api-version=1.0&query=${encodeURIComponent(record.zipcode + ", " + record.municipality + ", Portugal")}`;

        try {
            const response = await fetch(searchUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            
            if (result.results?.[0]?.position) {
                dataSource.add(new atlas.data.Feature(
                    new atlas.data.Point([
                        result.results[0].position.lon,
                        result.results[0].position.lat
                    ]), {
                        title: `${record.zipcode}, ${record.municipality}`
                    }
                ));
            }
        } catch (error) {
            console.error('Error processing location:', error);
            throw error; // Propagate error for retry handling
        }
    }

    // Main initialization function
    async function initialize() {
        try {
            const map = initializeMap();

            map.events.add('ready', async () => {
                try {
                    console.log('Fetching outage data...'); // Debug log
                    const records = await fetchOutageData();
                    console.log('Received records:', records.length); // Debug log

                    if (!records || records.length === 0) {
                        console.log('No records found'); // Debug log
                        displayNoOutagesMessage();
                        return;
                    }

                    const dataSource = new atlas.source.DataSource();
                    map.sources.add(dataSource);

                    // Process all locations
                    for (const record of records) {
                        await processLocation(dataSource, record);
                    }

                    // Setup layers and click handlers
                    const layers = createMapLayers(map, dataSource);
                    setupClickHandlers(map, dataSource, layers);
                } catch (error) {
                    console.error('Error in map ready handler:', error);
                    displayNoOutagesMessage();
                }
            });
        } catch (error) {
            console.error('Error initializing map:', error);
        }
    }

    // Start the application
    initialize();
  </script>
</body>

</html>