<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Portugal Electrical Grid interruptions</title>
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" type="text/css">
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    #myMap {
      height: 100vh;
      width: 100%;
    }

    #map-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 10px;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <div id="map-overlay">
    <h2>ðŸ‡µðŸ‡¹ Electrical Grid Outages</h2>
    <p>Data provided by <a
        href="https://e-redes.opendatasoft.com/explore/dataset/outages-per-geography/information/">E-REDES</a></p>
  </div>
  <div id="myMap"></div>
  <script>
    const CONFIG = {
        csvFilePath: "https://raw.githubusercontent.com/vpereira01/electricalgridptqos/master/data/records/latest.csv",
        subscriptionKey: '4GFIA7hQBBvNZi9ACsKWHSzkdxzyxmDpnlcBtlqn7PA34NsKhNcQJQQJ99ALAC5RqLJM3OneAAAgAZMP1dUS',
        mapSettings: {
            center: [-8.2245, 39.3999],
            zoom: 6.2,
            style: 'grayscale_dark',
            bounds: [-9.5, 36.8, -6.1, 42.2] // Continental Portugal bounds
        }
    };

    // Initialize map with configuration
    function initializeMap() {
        return new atlas.Map('myMap', {
            ...CONFIG.mapSettings,
            authOptions: {
                authType: 'subscriptionKey',
                subscriptionKey: CONFIG.subscriptionKey
            }
        });
    }

    // Handle case when no outages are reported
    function displayNoOutagesMessage() {
        const mapOverlay = document.getElementById('map-overlay');
        const message = document.createElement('p');
        message.innerHTML = 'Currently no outages reported.';
        mapOverlay.appendChild(message);
    }

    // Create layers for map visualization
    function createMapLayers(map, dataSource) {
        // Symbol layer for individual markers
        const symbolLayer = new atlas.layer.SymbolLayer(dataSource, null, {
            iconOptions: { image: 'marker-red' }
        });

        // Cluster layer for grouped markers
        const clusterLayer = new atlas.layer.BubbleLayer(dataSource, null, {
            radius: 12,
            color: '#007faa',
            strokeColor: 'white',
            strokeWidth: 2,
            filter: ['has', 'point_count']
        });

        // Labels for clusters
        const clusterLabelLayer = new atlas.layer.SymbolLayer(dataSource, null, {
            iconOptions: { image: 'none' },
            textOptions: {
                textField: ['get', 'point_count_abbreviated'],
                offset: [0, 0.4],
                color: 'white'
            },
            filter: ['has', 'point_count']
        });

        map.layers.add(symbolLayer);
        map.layers.add(clusterLayer);
        map.layers.add(clusterLabelLayer);

        return { symbolLayer, clusterLayer };
    }

    // Add click event handlers for popups
    function setupClickHandlers(map, dataSource, layers) {
        map.events.add('click', layers.symbolLayer, (e) => {
            if (e.shapes && e.shapes.length > 0) {
                new atlas.Popup({
                    content: e.shapes[0].getProperties().title,
                    position: e.position
                }).open(map);
            }
        });

        map.events.add('click', layers.clusterLayer, (e) => {
            const clusteredPoints = dataSource.getClusterLeaves(e.shapes[0], Infinity);
            const content = clusteredPoints
                .map(point => point.getProperties().title)
                .join('<br>');
            
            new atlas.Popup({
                content: `<div style="padding:10px"><b>Outages</b><br>${content}</div>`,
                position: e.position
            }).open(map);
        });
    }

    // Process location data and add to map
    async function processLocation(dataSource, location) {
        const searchUrl = `https://atlas.microsoft.com/search/address/json?subscription-key=${CONFIG.subscriptionKey}&api-version=1.0&query=${encodeURIComponent(location[".fields.zipcode"] + ", " + location[".fields.municipality"] + ", Portugal")}`;

        try {
            const response = await fetch(searchUrl);
            const result = await response.json();
            
            if (result.results && result.results.length > 0) {
                dataSource.add(new atlas.data.Feature(
                    new atlas.data.Point([
                        result.results[0].position.lon,
                        result.results[0].position.lat
                    ]), {
                        title: `${location[".fields.zipcode"]}, ${location[".fields.municipality"]}`
                    }
                ));
            }
        } catch (error) {
            console.error('Error processing location:', error);
        }
    }

    // Main initialization function
    async function initialize() {
        try {
            // Initialize map first
            const map = initializeMap();

            map.events.add('ready', async () => {
                try {
                    const data = await d3.csv(CONFIG.csvFilePath);
                    const filteredData = data.filter(r => r[".fields.municipality"]);

                    if (filteredData.length === 0) {
                        displayNoOutagesMessage();
                        return;
                    }

                    const dataSource = new atlas.source.DataSource();
                    map.sources.add(dataSource);

                    // Process all locations
                    filteredData.forEach(location => processLocation(dataSource, location));

                    // Setup layers and click handlers
                    const layers = createMapLayers(map, dataSource);
                    setupClickHandlers(map, dataSource, layers);
                } catch (error) {
                    console.error('Error loading outage data:', error);
                    displayNoOutagesMessage();
                }
            });
        } catch (error) {
            console.error('Error initializing map:', error);
        }
    }

    // Start the application
    initialize();
  </script>
</body>

</html>